{% extends 'resume/layout.html' %}
{% load static %}
{% block title %}Kaloforge: Resume{% endblock %}

{% block content %}
{% if resumes %}
<div class="d-flex flex-column flex-lg-row h-100">
    <!-- Sidebar -->
    <div class="sidebar bg-light border-end" id="resumeSidebar">
        <div class="d-lg-none p-2 border-bottom">
            <button class="btn btn-link text-dark" onclick="toggleSidebar()">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="p-3">
            <!-- Add Generate Button -->
            <div class="mb-4">
                <a href="{% url 'form' %}" class="btn btn-primary w-100">
                    <i class="bi bi-plus-circle me-2"></i>Generate Resume
                </a>
            </div>
            
            <h5 class="mb-3">Your Resumes</h5>
            {% for resume in resumes %}
            <div class="resume-item mb-3">
                <a href="#" 
                   class="text-decoration-none {% if resume.id == active_resume.id %}active{% endif %}"
                   data-resume-id="{{ resume.id }}"
                   onclick="showResume(this); return false;">
                    <div class="card shadow-sm hover-shadow">
                        <div class="card-body">
                            <div class="resume-preview-container mb-2">
                                <div class="resume-preview">
                                    {{ resume.html_template|safe }}
                                </div>
                            </div>
                            <h6 class="card-title text-truncate mb-2">{{ resume.data.name }}</h6>
                            <small class="text-muted">{{ resume.created_at|date:"M d, Y" }}</small>
                        </div>
                    </div>
                </a>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Toggle Sidebar Button for Mobile -->
    <div class="d-lg-none position-fixed bottom-0 start-0 p-3" style="z-index: 1030;">
        <button class="btn btn-primary rounded-circle shadow" onclick="toggleSidebar()">
            <i class="bi bi-list"></i>
        </button>
    </div>

    <!-- Main Content -->
    <div class="flex-grow-1 p-4 overflow-auto">
        <div class="d-flex justify-content-center">
            <div id="resume-preview" class="resume-preview-main">
                {% if active_resume %}
                    {{ active_resume.html_template|safe }}
                {% else %}
                    <div class="text-center text-muted mt-5">
                        <p>Select a resume from the sidebar to preview</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<style>
.sidebar {
    width: 300px;
    height: calc(100vh - 56px);
    overflow-y: auto;
    transition: all 0.3s ease;
}

@media (max-width: 991.98px) {
    .sidebar {
        position: fixed;
        left: -300px;
        top: 0;
        bottom: 0;
        z-index: 1040;
        width: 300px;
        height: 100vh;
    }

    .sidebar.show {
        left: 0;
    }
}

.resume-preview-container {
    height: 150px;
    position: relative;
    overflow: hidden;
    border: 1px solid rgba(0,0,0,0.1);
    border-radius: 4px;
}

.resume-preview-main {
    width: 100%;
    max-width: 21cm;
    min-height: 29.7cm;
    background: white;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    margin-bottom: 2rem;
    padding: 2rem;
    transform-origin: top center;
}

@media (max-width: 991.98px) {
    .resume-preview-main {
        padding: 1rem;
        transform: scale(0.8);
        margin: -10% auto;
    }
}

@media (max-width: 767.98px) {
    .resume-preview-main {
        transform: scale(0.6);
        margin: -20% auto;
    }
}

@media (max-width: 575.98px) {
    .resume-preview-main {
        transform: scale(0.5);
        margin: -25% auto;
    }
    
    .sidebar {
        width: 100%;
        max-width: 300px;
    }
}

/* Add styles for the generate button */
.btn-primary {
    transition: all 0.3s ease;
}

.btn-primary:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.15);
}

/* Add these new styles */
#resume-preview {
    overflow: hidden;
    padding: 2rem;
}

.overflow-auto {
    -webkit-overflow-scrolling: touch;
}

@media print {
    .sidebar {
        display: none;
    }
    
    #resume-preview {
        box-shadow: none !important;
        margin: 0 !important;
        padding: 0 !important;
    }
}

/* New styles */
.resume-preview-main {
    cursor: pointer;
    transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.resume-preview-main:hover {
    transform: scale(1.01);
    box-shadow: 0 0 20px rgba(0,0,0,0.15) !important;
}

/* Add zoom controls */
.zoom-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    display: flex;
    gap: 0.5rem;
}

.zoom-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: white;
    border: none;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.zoom-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
</style>

<!-- Add zoom controls -->
<div class="zoom-controls d-none d-md-flex">
    <button class="zoom-btn" onclick="zoomResume('in')">
        <i class="bi bi-zoom-in"></i>
    </button>
    <button class="zoom-btn" onclick="zoomResume('out')">
        <i class="bi bi-zoom-out"></i>
    </button>
</div>

<script>
function toggleSidebar() {
    const sidebar = document.getElementById('resumeSidebar');
    sidebar.classList.toggle('show');
}

// Close sidebar when clicking outside on mobile
document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('resumeSidebar');
    const toggleBtn = document.querySelector('[onclick="toggleSidebar()"]');
    
    if (window.innerWidth < 992 && // Only on mobile
        !sidebar.contains(event.target) && // Click outside sidebar
        !toggleBtn.contains(event.target) && // Not clicking toggle button
        sidebar.classList.contains('show')) { // Sidebar is visible
        sidebar.classList.remove('show');
    }
});

function showResume(element) {
    const resumeId = element.getAttribute('data-resume-id');
    updateResumePreview(resumeId);
}

function updateResumePreview(resumeId) {
    fetch(`/api/resume/${resumeId}/`)
        .then(response => response.json())
        .then(data => {
            const previewDiv = document.getElementById('resume-preview');
            previewDiv.innerHTML = data.html_template;
            
            // Update active state in sidebar
            document.querySelectorAll('.resume-item a').forEach(a => {
                if (a.getAttribute('data-resume-id') === resumeId) {
                    a.classList.add('active');
                } else {
                    a.classList.remove('active');
                }
            });
        });
}

// Add click handler for main preview
document.getElementById('resume-preview').addEventListener('click', function() {
    const activeResume = document.querySelector('.resume-item a.active');
    if (activeResume) {
        const resumeId = activeResume.getAttribute('data-resume-id');
        updateResumePreview(resumeId);
    }
});

let currentScale = 1;
const MIN_SCALE = 0.5;
const MAX_SCALE = 1.5;

function zoomResume(direction) {
    const preview = document.getElementById('resume-preview');
    const scaleChange = direction === 'in' ? 0.1 : -0.1;
    const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale + scaleChange));
    
    if (newScale !== currentScale) {
        currentScale = newScale;
        preview.style.transform = `scale(${currentScale})`;
    }
}

// Add touch gesture support for zooming
let touchStartDistance = 0;
const preview = document.getElementById('resume-preview');

preview.addEventListener('touchstart', (e) => {
    if (e.touches.length === 2) {
        touchStartDistance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
        );
    }
});

preview.addEventListener('touchmove', (e) => {
    if (e.touches.length === 2) {
        e.preventDefault();
        const currentDistance = Math.hypot(
            e.touches[0].pageX - e.touches[1].pageX,
            e.touches[0].pageY - e.touches[1].pageY
        );
        
        const scale = (currentDistance - touchStartDistance) * 0.01;
        const newScale = Math.max(MIN_SCALE, Math.min(MAX_SCALE, currentScale + scale));
        
        if (newScale !== currentScale) {
            currentScale = newScale;
            preview.style.transform = `scale(${currentScale})`;
        }
        
        touchStartDistance = currentDistance;
    }
});
</script>

{% else %}
<div class="container d-flex align-items-center justify-content-center min-vh-100">
    <div class="text-center">
        <img src="{% static 'resume/images/resume.png' %}" 
             alt="No resumes yet" 
             class="empty-state-img"
             width="250" 
             height="250">
        <h1 class="display-4 fw-bold mb-4">Create Your Professional Resume</h1>
        <p class="lead mb-4 text-muted">
            Craft a stunning resume in minutes with our AI-powered resume builder. 
            <br>Simple, smart, and professional.
        </p>
        <div class="d-grid col-md-8 mx-auto">
            <a href="{% url 'form' %}" class="btn btn-primary btn-lg shadow-sm">
                <i class="bi bi-plus-circle me-2"></i>Create Resume
            </a>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}